# AI Development Constitution (CLAUDE.md)

Uncharted Territory - 宇宙経済シミュレーションゲームの技術開発履歴とナレッジベース

## プロジェクト概要

**目標**: X3/X4 + Factorio風の宇宙経済シミュレーションゲーム
**技術**: TypeScript フルスタック、Express + Cloudflare Workers デュアル実装
**開発期間**: MVP完成まで約4時間（2024-06-24）

## 開発戦略と意思決定

### 🎯 Issue#1: MVP実装の方針転換

**初期誤解**: Issue#1を「タスク管理API」として誤認
**方針転換**: 仕様書を再読し、宇宙経済シミュレーションゲームと正しく理解
**学習**: 複雑な仕様は「Think hard」で分析・整理してから実装開始

### 🏗️ アーキテクチャ設計決定

#### モジュラー設計の採用
```
types.ts → 共通データ型定義
world-generator.ts → 宇宙生成システム  
economic-engine.ts → 価格変動・生産システム
ship-engine.ts → 移動・探索・交易システム
index.ts / worker.ts → API層（Express/Workers）
```

**判断理由**:
- 複雑なシステムの分離・独立性確保
- 段階的な拡張・修正の容易性
- テスタビリティの向上

#### デュアル実装戦略
- **Express.js**: 開発効率重視、デバッグ容易
- **Cloudflare Workers**: 本番性能重視、グローバル配信
- **共通ロジック**: ビジネスロジックの重複排除

### 🧪 品質保証アプローチ

#### テスト戦略
```
API統合テスト: index.test.ts (17テスト)
Workers機能テスト: worker.test.ts (16テスト)  
カバレッジ目標: 80%+ (現在68.45%)
```

#### 品質チェック自動化
```bash
npm run typecheck  # TypeScript strict mode
npm run lint       # ESLint品質チェック
npm test          # 全テスト実行
npm run test:coverage # カバレッジ測定
```

### 📊 開発過程の技術的課題と解決

#### 1. 依存関係の競合
**問題**: `@vitest/coverage-v8@3.2.4` と `vitest@1.6.1` の不整合
**解決**: package.jsonでバージョン統一 (`^1.6.1`)

#### 2. TypeScript strict mode エラー
**問題**: optional プロパティの undefined 代入エラー
**解決**: 型定義の明示的 undefined 許可、null チェック追加

#### 3. ESLint設定の簡素化
**問題**: `@typescript-eslint/recommended` 拡張の依存関係エラー
**解決**: 基本設定のみに簡素化、段階的な品質向上

#### 4. テストの安定性
**問題**: 非決定的テスト（時間依存、距離計算等）
**解決**: 許容範囲の設定、モック化検討

### 🔧 開発効率化の工夫

#### 1. TodoWrite/TodoRead の積極活用
```typescript
// 8つの主要タスクに分解
1. データ構造設計
2. 世界生成実装  
3. 経済エンジン
4. 船舶システム
5. 交易システム
6. API設計
7. テスト実装
8. 品質チェック
```

#### 2. 同時並行開発
- 複数ファイルの並行作成
- Express + Workers の同時実装
- テストと実装の並行進行

#### 3. 型安全性重視
- インターフェース先行設計
- strict mode での厳密な型チェック
- 実行時エラーの最小化

### 📚 設計ドキュメント化戦略

**動機**: 一気実装による修正困難性の解決
**アプローチ**: 機能別の詳細設計書作成

#### 作成したドキュメント
1. **ARCHITECTURE.md**: 全体設計・技術選定理由
2. **DATA_MODEL.md**: TypeScript型設計・データ関係
3. **WORLD_GENERATION.md**: 宇宙生成アルゴリズム
4. **ECONOMIC_ENGINE.md**: 価格変動・生産システム
5. **SHIP_ENGINE.md**: 移動・探索・交易メカニズム
6. **API_DESIGN.md**: RESTful設計・エラーハンドリング
7. **TESTING_STRATEGY.md**: 品質保証・カバレッジ戦略
8. **GAMEPLAY_GUIDE.md**: 実際のプレイ方法（API使用）

**効果**: 部分修正の容易性、新規参加者の理解促進、設計判断の記録

### 🚀 パフォーマンス最適化

#### メモリ効率
- ゲーム状態のインメモリ管理（MVP版）
- イベント履歴の制限（直近10件）
- 交易機会の上位20件制限

#### 計算効率
- 差分更新（60秒サイクル制限）
- リアルタイム価格計算の最適化
- 距離計算の簡略化

### 🔄 継続的改善プロセス

#### 短期改善（1-2週間）
- テストカバレッジ80%達成
- カバレッジ不足領域の特定・改善
- エラーハンドリングの強化

#### 中期改善（1-2ヶ月）  
- データベース永続化
- WebSocket リアルタイム通信
- 自動化機能（AI交易）

#### 長期改善（3-6ヶ月）
- フロントエンド実装
- マルチプレイヤー対応
- 高度な経済シミュレーション

## 開発効率化のナレッジ

### ✅ 効果的だった手法

1. **TodoWrite による進捗管理**: 複雑タスクの見える化
2. **型先行設計**: 実装前のインターフェース設計
3. **デュアル実装**: 開発・本番環境の最適化
4. **テスト駆動**: 安全なリファクタリング基盤
5. **設計書による振り返り**: 一気実装の問題解決

### ⚠️ 改善が必要な点

1. **仕様理解不足**: 初期の誤解による手戻り
2. **カバレッジ不足**: テスト実装の後回し
3. **依存関係管理**: バージョン競合の事前確認不足
4. **段階的実装**: 一気実装による修正困難性

### 🛠 推奨開発フロー

```
1. 仕様書の詳細分析（Think hard）
2. TodoWrite でタスク分解
3. 型定義・インターフェース設計
4. テスト先行実装
5. ビジネスロジック実装
6. API層統合
7. 品質チェック・カバレッジ確認
8. 設計書による振り返り・文書化
```

### 📋 技術スタック評価

#### 採用技術
- **TypeScript**: 型安全性、開発効率 ⭐⭐⭐⭐⭐
- **Vitest**: テスト実行速度、モダンAPI ⭐⭐⭐⭐⭐  
- **Express.js**: 開発効率、エコシステム ⭐⭐⭐⭐⭐
- **Cloudflare Workers**: 性能、グローバル配信 ⭐⭐⭐⭐⭐

#### 検討・改善点
- **ESLint設定**: より厳密な設定への段階的移行
- **データベース**: 永続化層の追加
- **リアルタイム通信**: WebSocket/SSE の検討

## コマンド・ツール

### 開発コマンド
```bash
npm run dev          # Express開発サーバー
npm run dev:worker   # Workers開発サーバー
npm run test         # テスト実行
npm run test:coverage # カバレッジ測定
npm run lint         # 品質チェック
npm run typecheck    # 型チェック
npm run precommit    # プリコミットチェック
```

### 品質基準
- **TypeScript strict mode** ✅
- **ESLint エラーゼロ** ✅  
- **テストカバレッジ** 68.45% → 80%+ (改善中)
- **全テスト成功** ✅

### Claude Code最適化
- **TodoWrite/TodoRead**: 進捗管理の徹底
- **一括処理**: 複数ツール同時実行
- **設計先行**: Think hardによる事前分析
- **文書化**: 振り返りと知識蓄積

---

**更新履歴**
- 2024-06-24: MVP実装完了、設計ドキュメント整備、技術的振り返り完了
